<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>章 4. 簡單例子</title>
    <link rel="stylesheet" type="text/css" href="debian.css"/>
    <meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="home" href="index.zh-tw.html" title="Debian 維護者指南"/>
    <link rel="up" href="index.zh-tw.html" title="Debian 維護者指南"/>
    <link rel="prev" href="ch03.zh-tw.html" title="章 3. 工具的配置"/>
    <link rel="next" href="ch05.zh-tw.html" title="章 5. 基本內容"/>
  </head>
  <body>
    <div class="navheader">
      <table width="100%" summary="Navigation header">
        <tr>
          <th colspan="3" align="center">章 4. 簡單例子</th>
        </tr>
        <tr>
          <td align="left"><a accesskey="p" href="ch03.zh-tw.html"><img src="images/prev.png" alt="前一頁"/></a> </td>
          <th width="60%" align="center"> </th>
          <td align="right"> <a accesskey="n" href="ch05.zh-tw.html"><img src="images/next.png" alt="下一頁"/></a></td>
        </tr>
      </table>
      <hr/>
    </div>
    <div class="chapter">
      <div class="titlepage">
        <div>
          <div>
            <h1 class="title"><a id="simple"/>章 4. 簡單例子</h1>
          </div>
        </div>
      </div>
      <div class="toc">
        <p>
          <strong>內容目錄</strong>
        </p>
        <dl class="toc">
          <dt>
            <span class="section">
              <a href="ch04.zh-tw.html#big-picture">4.1. 大致流程</a>
            </span>
          </dt>
          <dt>
            <span class="section">
              <a href="ch04.zh-tw.html#what-debmake">4.2. 什麼是 debmake？</a>
            </span>
          </dt>
          <dt>
            <span class="section">
              <a href="ch04.zh-tw.html#what-debuild">4.3. 什麼是 debuild？</a>
            </span>
          </dt>
          <dt>
            <span class="section">
              <a href="ch04.zh-tw.html#step-upstream">4.4. 第一步：取得上游原始碼</a>
            </span>
          </dt>
          <dt>
            <span class="section">
              <a href="ch04.zh-tw.html#step-debmake">4.5. 第二步：使用 debmake 產生模板檔案</a>
            </span>
          </dt>
          <dt>
            <span class="section">
              <a href="ch04.zh-tw.html#step-maintainer">4.6. 第三步：編輯模板檔案</a>
            </span>
          </dt>
          <dt>
            <span class="section">
              <a href="ch04.zh-tw.html#step-debuild">4.7. 第四步：使用 debuild 構建套件</a>
            </span>
          </dt>
          <dt>
            <span class="section">
              <a href="ch04.zh-tw.html#alt-patch">4.8. 第三步（備選）：修改上游原始碼</a>
            </span>
          </dt>
          <dd>
            <dl>
              <dt>
                <span class="section">
                  <a href="ch04.zh-tw.html#diff-u">4.8.1. 使用 diff -u 處理補丁</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="ch04.zh-tw.html#dquilt">4.8.2. 使用 dquilt 處理補丁</a>
                </span>
              </dt>
              <dt>
                <span class="section">
                  <a href="ch04.zh-tw.html#dpkg-source-commit">4.8.3. 使用 dpkg-source --commit 處理補丁</a>
                </span>
              </dt>
            </dl>
          </dd>
        </dl>
      </div>
      <p>有一句古羅馬諺語說得好：“<span class="strong"><strong>Longum iter est per praecepta, breve et efficax per exempla</strong></span>”（“<span class="strong"><strong>一例勝千言！</strong></span>”）。</p>
      <p>這裡給出了從簡單的 C 語言原始碼建立簡單的 Debian 套件的例子，並假設上游使用了 <span class="strong"><strong>Makefile</strong></span> 作為構建系統。</p>
      <p>我們假設上游原始碼壓縮包（tarball）名稱為 <span class="strong"><strong>debhello-0.0.tar.gz</strong></span>。</p>
      <p>這一類原始碼設計可以用這樣的方式安裝成為非系統檔案：</p>
      <pre class="screen"> $ tar -xzmf debhello-0.0.tar.gz
 $ cd debhello-0.0
 $ make
 $ make install</pre>
      <p>Debian 的打包需要對“<span class="strong"><strong>make install</strong></span>”流程進行改變，從而將檔案安裝至目標系統映象所在位置，而非通常使用的 <span class="strong"><strong>/usr/local</strong></span> 下的位置。</p>
      <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
        <table border="0" summary="Note">
          <tr>
            <td rowspan="2" align="center" valign="top">
              <img alt="[注意]" src="images/note.png"/>
            </td>
            <th align="left">注意</th>
          </tr>
          <tr>
            <td align="left" valign="top">
              <p>在其它更加複雜的構建系統下構建 Debian 套件的例子可以在 <a class="xref" href="ch08.zh-tw.html" title="章 8. 更多範例">章 8, <em>更多範例</em></a> 找到。</p>
            </td>
          </tr>
        </table>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="big-picture"/>4.1. 大致流程</h2>
            </div>
          </div>
        </div>
        <p>從上游原始碼壓縮包 <span class="strong"><strong>debhello-0.0.tar.gz</strong></span> 構建單個非原生 Debian 套件的大致流程可以總結如下：</p>
        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem">維護者取得上游原始碼壓縮包 <span class="strong"><strong>debhello-0.0.tar.gz</strong></span> 並將其內容解壓縮至 <span class="strong"><strong>debhello-0.0</strong></span> 目錄中。</li>
            <li class="listitem">
              <p class="simpara"><span class="strong"><strong>debmake</strong></span> 命令對上游原始碼樹進行 debian 化（debianize），具體來說，是建立一個 <span class="strong"><strong>debian</strong></span> 目錄並僅向該目錄中新增各類模板檔案。</p>
              <div class="itemizedlist">
                <ul class="itemizedlist">
                  <li class="listitem">名為 <span class="strong"><strong>debhello_0.0.orig.tar.gz</strong></span> 的符號連結被建立並指向 <span class="strong"><strong>debhello-0.0.tar.gz</strong></span> 檔案。</li>
                  <li class="listitem">維護者須自行編輯修改模板檔案。</li>
                </ul>
              </div>
            </li>
            <li class="listitem">
              <p class="simpara"><span class="strong"><strong>debuild</strong></span> 命令基於已 debian 化的原始碼樹構建二進位制套件。</p>
              <div class="itemizedlist">
                <ul class="itemizedlist">
                  <li class="listitem"><span class="strong"><strong>debhello-0.0-1.debian.tar.xz</strong></span> 將被建立，它包含了 <span class="strong"><strong>debian</strong></span> 目錄。</li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
        <p><strong>套件構建的大致流程. </strong>
</p>
        <pre class="screen"> $ tar -xzmf debhello-0.0.tar.gz
 $ cd debhello-0.0
 $ debmake
   ... manual customization
 $ debuild
   ...</pre>
        <p>
</p>
        <div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Tip">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[提示]" src="images/tip.png"/>
              </td>
              <th align="left">提示</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>此處和下面例子中的 <span class="strong"><strong>debuild</strong></span> 命令可使用等價的命令進行替換，例如 <span class="strong"><strong>pdebuild</strong></span> 命令。</p>
              </td>
            </tr>
          </table>
        </div>
        <div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Tip">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[提示]" src="images/tip.png"/>
              </td>
              <th align="left">提示</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>如果上游原始碼壓縮包提供了 <span class="strong"><strong>.tar.xz</strong></span> 格式文件，請使用這樣的壓縮包來替代 <span class="strong"><strong>.tar.gz</strong></span> 或 <span class="strong"><strong>.tar.bz2</strong></span> 格式。<span class="strong"><strong>xz</strong></span> 壓縮與 <span class="strong"><strong>gzip</strong></span> 或 <span class="strong"><strong>bzip2</strong></span> 壓縮相比提供了更好的壓縮比。</p>
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="what-debmake"/>4.2. 什麼是 debmake？</h2>
            </div>
          </div>
        </div>
        <p>文中的 <span class="strong"><strong>debmake</strong></span> 命令是用於 Debian 打包的一個輔助腳本。</p>
        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem">它總是將大多數選項的狀態與引數設定為合理的預設值。</li>
            <li class="listitem">它能產生上游原始碼包，並按需建立所需的符號連結。</li>
            <li class="listitem">它不會覆寫 <span class="strong"><strong>debian/</strong></span> 目錄下已存在的配置文件。</li>
            <li class="listitem">它支援多架構（<span class="strong"><strong>multiarch</strong></span>）套件。</li>
            <li class="listitem">它能建立良好的模板檔案，例如符合 <span class="strong"><strong>DEP-5</strong></span> 的 <span class="strong"><strong>debian/copyright</strong></span> 檔案。</li>
          </ul>
        </div>
        <p>這些特性使得使用 <span class="strong"><strong>debmake</strong></span> 進行 Debian 打包工作變得簡單而現代化。</p>
        <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Note">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[注意]" src="images/note.png"/>
              </td>
              <th align="left">注意</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p><span class="strong"><strong>debmake</strong></span> 命令並不是製作一個 Debian 套件的唯一途徑。許多套件是打包者模仿其它已有的打包範例，僅僅使用文字編輯器而編寫完成打包指令碼的。</p>
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="what-debuild"/>4.3. 什麼是 debuild？</h2>
            </div>
          </div>
        </div>
        <p>這裡給出與 <span class="strong"><strong>debuild</strong></span> 命令類似的一系列命令的一個彙總。</p>
        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem"><span class="strong"><strong>debian/rules</strong></span> 檔案定義了 Debian 二進位制套件該如何構建。</li>
            <li class="listitem">
              <p class="simpara"><span class="strong"><strong>dpkg-buildpackge</strong></span> 是構建 Debian 二進位制套件的正式命令。對於正常的二進位制構建，它大體上會執行以下操作：</p>
              <div class="itemizedlist">
                <ul class="itemizedlist">
                  <li class="listitem">“<span class="strong"><strong>dpkg-source --before-build</strong></span>”（應用 Debian 補丁，除非它們已被應用）</li>
                  <li class="listitem">“<span class="strong"><strong>fakeroot debian/rules clean</strong></span>”</li>
                  <li class="listitem">“<span class="strong"><strong>dpkg-source --build</strong></span>”（構建 Debian 原始碼包）</li>
                  <li class="listitem">“<span class="strong"><strong>fakeroot debian/rules build</strong></span>”</li>
                  <li class="listitem">“<span class="strong"><strong>fakeroot debian/rules binary</strong></span>”</li>
                  <li class="listitem">“<span class="strong"><strong>dpkg-genbuildinfo</strong></span>”（產生一個 <span class="strong"><strong>*.buildinfo</strong></span> 檔案）</li>
                  <li class="listitem">“<span class="strong"><strong>dpkg-genchanges</strong></span>”（產生一個 <span class="strong"><strong>*.changes</strong></span> 檔案）</li>
                  <li class="listitem">“<span class="strong"><strong>fakeroot debian/rules clean</strong></span>”</li>
                  <li class="listitem">“<span class="strong"><strong>dpkg-source --after-build</strong></span>”（取消 Debian 補丁，如果它們在 <span class="strong"><strong>--before-build</strong></span> 階段已被應用）</li>
                  <li class="listitem">
                    <p class="simpara">“<span class="strong"><strong>debsign</strong></span>”（對 <span class="strong"><strong>*.dsc</strong></span> 和 <span class="strong"><strong>*.changes</strong></span> 檔案進行簽名）</p>
                    <div class="itemizedlist">
                      <ul class="itemizedlist">
                        <li class="listitem">如果您按照 <a class="xref" href="ch03.zh-tw.html#devscripts-setup" title="3.5. devscripts">節 3.5, “devscripts”</a> 的說明設定了 <span class="strong"><strong>-us</strong></span> 和 <span class="strong"><strong>-us</strong></span> 選項的話，本步驟將會被跳過。您需要手動執行 <span class="strong"><strong>debsign</strong></span> 命令。</li>
                      </ul>
                    </div>
                  </li>
                </ul>
              </div>
            </li>
            <li class="listitem"><span class="strong"><strong>debuild</strong></span> 命令是 <span class="strong"><strong>dpkg-buildpackage</strong></span> 命令的一個封裝指令碼，它可以使用合適的環境變數來構建 Debian 二進位制套件。</li>
            <li class="listitem"><span class="strong"><strong>pdebuild</strong></span> 命令是另一個封裝指令碼，它可以在合適的 chroot 環境下使用合適的環境變數構建 Debian 二進位制套件。</li>
            <li class="listitem"><span class="strong"><strong>git-pbuilder</strong></span> 命令是又一個用於構建 Debian 二進位制套件的封裝指令碼，它同樣可以確保使用合適的環境變數和 chroot 環境。不同之處在於它提供了一個更容易使用的命令列使用者介面，可以較方便地在不同的構建環境之間進行切換。</li>
          </ul>
        </div>
        <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Note">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[注意]" src="images/note.png"/>
              </td>
              <th align="left">注意</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>如需瞭解詳細內容，請見 <span class="strong"><strong>dpkg-buildpackage</strong></span>(1)。</p>
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="step-upstream"/>4.4. 第一步：取得上游原始碼</h2>
            </div>
          </div>
        </div>
        <p>我們先要取得上游原始碼。</p>
        <p><strong>下載 <span class="strong"><strong>debhello-0.0.tar.gz</strong></span>. </strong>
</p>
        <pre class="screen"> $ wget http://www.example.org/download/debhello-0.0.tar.gz
 ...
 $ tar -xzf debhello-0.0.tar.gz
 $ tree
.
├── debhello-0.0
│   ├── LICENSE
│   ├── Makefile
│   └── src
│       └── hello.c
└── debhello-0.0.tar.gz

2 directories, 4 files</pre>
        <p>
</p>
        <p>這裡的 C 原始碼 <span class="strong"><strong>hello.c</strong></span> 非常的簡單。</p>
        <p><strong><span class="strong"><strong>hello.c</strong></span>. </strong>
</p>
        <pre class="screen"> $ cat debhello-0.0/src/hello.c
#include &lt;stdio.h&gt;
int
main()
{
        printf("Hello, world!\n");
        return 0;
}</pre>
        <p>
</p>
        <p>這裡，原始碼中的 <span class="strong"><strong>Makefile</strong></span> 支援 <a class="ulink" href="https://www.gnu.org/prep/standards/">GNU 編碼標準</a> 和 <a class="ulink" href="https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard">FHS（檔案系統層級規範）</a>。特別地：</p>
        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem">構建二進位制程式時會考慮 <span class="strong"><strong>$(CPPFLAGS)</strong></span>、<span class="strong"><strong>$(CFLAGS)</strong></span>、<span class="strong"><strong>$(LDFLAGS)</strong></span>，等等。</li>
            <li class="listitem">安裝檔案時採納 <span class="strong"><strong>$(DESTDIR)</strong></span> 作為目標系統鏡像的路徑字首</li>
            <li class="listitem">安裝檔案時使用 <span class="strong"><strong>$(prefix)</strong></span> 的值，以便我們將其設定覆蓋為 <span class="strong"><strong>/usr</strong></span></li>
          </ul>
        </div>
        <p><strong><span class="strong"><strong>Makefile</strong></span>. </strong>
</p>
        <pre class="screen"> $ cat debhello-0.0/Makefile
prefix = /usr/local

all: src/hello

src/hello: src/hello.c
        @echo "CFLAGS=$(CFLAGS)" | \
                fold -s -w 70 | \
                sed -e 's/^/# /'
        $(CC) $(CPPFLAGS) $(CFLAGS) $(LDCFLAGS) -o $@ $^

install: src/hello
        install -D src/hello \
                $(DESTDIR)$(prefix)/bin/hello

clean:
        -rm -f src/hello

distclean: clean

uninstall:
        -rm -f $(DESTDIR)$(prefix)/bin/hello

.PHONY: all install clean distclean uninstall</pre>
        <p>
</p>
        <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Note">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[注意]" src="images/note.png"/>
              </td>
              <th align="left">注意</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>對 <span class="strong"><strong>$(CFLAGS)</strong></span> 的 <span class="strong"><strong>echo</strong></span> 命令用於在接下來的例子中驗證所設定的構建引數。</p>
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="step-debmake"/>4.5. 第二步：使用 debmake 產生模板檔案</h2>
            </div>
          </div>
        </div>
        <div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Tip">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[提示]" src="images/tip.png"/>
              </td>
              <th align="left">提示</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>如果 <span class="strong"><strong>debmake</strong></span> 命令呼叫時使用了 <span class="strong"><strong>-T</strong></span> 選項，程式將為模板檔案產生更加詳細的註釋內容。</p>
              </td>
            </tr>
          </table>
        </div>
        <p><span class="strong"><strong>debmake</strong></span> 命令的輸出十分詳細，如下所示，它可以展示程式的具體操作內容。</p>
        <pre class="screen"> $ cd debhello-0.0
 $ debmake
I: set parameters
I: sanity check of parameters
I: pkg="debhello", ver="0.0", rev="1"
I: *** start packaging in "debhello-0.0". ***
I: provide debhello_0.0.orig.tar.gz for non-native Debian package
I: pwd = "/path/to"
I: $ ln -sf debhello-0.0.tar.gz debhello_0.0.orig.tar.gz
I: pwd = "/path/to/debhello-0.0"
I: parse binary package settings:
I: binary package=debhello Type=bin / Arch=any M-A=foreign
I: analyze the source tree
I: build_type = make
I: scan source for copyright+license text and file extensions
I: 100 %, ext = c
I: check_all_licenses
I: ..
I: check_all_licenses completed for 2 files.
I: bunch_all_licenses
I: format_all_licenses
I: make debian/* template files
I: single binary package
I: debmake -x "1" ...
I: creating =&gt; debian/control
I: creating =&gt; debian/copyright
I: substituting =&gt; /usr/share/debmake/extra0/changelog
I: creating =&gt; debian/changelog
I: substituting =&gt; /usr/share/debmake/extra0/rules
I: creating =&gt; debian/rules
I: substituting =&gt; /usr/share/debmake/extra1/README.Debian
I: creating =&gt; debian/README.Debian
I: substituting =&gt; /usr/share/debmake/extra1/compat
I: creating =&gt; debian/compat
I: substituting =&gt; /usr/share/debmake/extra1/watch
I: creating =&gt; debian/watch
I: substituting =&gt; /usr/share/debmake/extra1source/local-options
I: creating =&gt; debian/source/local-options
I: substituting =&gt; /usr/share/debmake/extra1source/format
I: creating =&gt; debian/source/format
I: substituting =&gt; /usr/share/debmake/extra1patches/series
I: creating =&gt; debian/patches/series
I: run "debmake -x2" to get more template files
I: $ wrap-and-sort</pre>
        <p><span class="strong"><strong>debmake</strong></span> 命令基於命令列選項產生所有這些模板檔案。如果沒有指定具體選項，<span class="strong"><strong>debmake</strong></span> 命令將為您自動選擇合理的預設值：</p>
        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem">原始碼包名稱：<span class="strong"><strong>debhello</strong></span></li>
            <li class="listitem">上游版本：<span class="strong"><strong>0.0</strong></span></li>
            <li class="listitem">二進位制套件名稱：<span class="strong"><strong>debhello</strong></span></li>
            <li class="listitem">Debian 修訂版本：<span class="strong"><strong>1</strong></span></li>
            <li class="listitem">套件型別： <span class="strong"><strong>bin</strong></span>（ELF 二進位制可執行程式套件）</li>
            <li class="listitem"><span class="strong"><strong>-x</strong></span> 選項：<span class="strong"><strong>-x1</strong></span>（是單個二進位制套件的預設值）</li>
          </ul>
        </div>
        <p>我們來檢查一下自動產生的模板檔案。</p>
        <p><strong>基本 <span class="strong"><strong>debmake</strong></span> 命令執行後的原始碼樹。. </strong>
</p>
        <pre class="screen"> $ cd ..
 $ tree
.
├── debhello-0.0
│   ├── LICENSE
│   ├── Makefile
│   ├── debian
│   │   ├── README.Debian
│   │   ├── changelog
│   │   ├── compat
│   │   ├── control
│   │   ├── copyright
│   │   ├── patches
│   │   │   └── series
│   │   ├── rules
│   │   ├── source
│   │   │   ├── format
│   │   │   └── local-options
│   │   └── watch
│   └── src
│       └── hello.c
├── debhello-0.0.tar.gz
└── debhello_0.0.orig.tar.gz -&gt; debhello-0.0.tar.gz

5 directories, 15 files</pre>
        <p>
</p>
        <p>這裡的 <span class="strong"><strong>debian/rules</strong></span> 檔案是應當由套件維護者提供的構建指令碼。此時該檔案是由 <span class="strong"><strong>debmake</strong></span> 命令產生的模板檔案。</p>
        <p><strong><span class="strong"><strong>debian/rules</strong></span>（模板檔案）：. </strong>
</p>
        <pre class="screen"> $ cat debhello-0.0/debian/rules
#!/usr/bin/make -f
# You must remove unused comment lines for the released package.
#export DH_VERBOSE = 1
#export DEB_BUILD_MAINT_OPTIONS = hardening=+all
#export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
#export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed

%:
        dh $@

#override_dh_auto_install:
#       dh_auto_install -- prefix=/usr

#override_dh_install:
#       dh_install --list-missing -X.pyc -X.pyo</pre>
        <p>
</p>
        <p>這便是使用 <span class="strong"><strong>dh</strong></span> 命令時標準的 <span class="strong"><strong>debian/rules</strong></span> 檔案。（某些內容已被註釋，可供後續修改使用。）</p>
        <p>這裡的 <span class="strong"><strong>debian/control</strong></span> 檔案提供了 Debian 套件的主要參數。此時該檔案是由 <span class="strong"><strong>debmake</strong></span> 命令產生的模板檔案。</p>
        <p><strong><span class="strong"><strong>debian/control</strong></span>（模板檔案）：. </strong>
</p>
        <pre class="screen"> $ cat debhello-0.0/debian/control
Source: debhello
Section: unknown
Priority: optional
Maintainer: "Firstname Lastname" &lt;email.address@example.org&gt;
Build-Depends: debhelper (&gt;=11~)
Standards-Version: 4.1.4
Homepage: &lt;insert the upstream URL, if relevant&gt;

Package: debhello
Architecture: any
Multi-Arch: foreign
Depends: ${misc:Depends}, ${shlibs:Depends}
Description: auto-generated package by debmake
 This Debian binary package was auto-generated by the
 debmake(1) command provided by the debmake package.</pre>
        <p>
</p>
        <div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Warning">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[警告]" src="images/warning.png"/>
              </td>
              <th align="left">警告</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>如果您對 <span class="strong"><strong>debian/control</strong></span> 模板檔案中的“<span class="strong"><strong>Section: unknown</strong></span>”部分不做修改的話，後續的 <span class="strong"><strong>lintian</strong></span> 錯誤可能導致構建失敗。</p>
              </td>
            </tr>
          </table>
        </div>
        <p>因為這是個 ELF 二進位制可執行檔案套件，<span class="strong"><strong>debmake</strong></span> 命令設定了“<span class="strong"><strong>Architecture: any</strong></span>”和“<span class="strong"><strong>Multi-Arch: foreign</strong></span>”兩項。同時，它將所需的 <span class="strong"><strong>substvar</strong></span> 引數設定為“<span class="strong"><strong>Depends: ${shlibs:Depends}, ${misc:Depends}</strong></span>”。這些內容將在 <a class="xref" href="ch05.zh-tw.html" title="章 5. 基本內容">章 5, <em>基本內容</em></a> 部分進行解釋。</p>
        <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Note">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[注意]" src="images/note.png"/>
              </td>
              <th align="left">注意</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>請注意這個 <span class="strong"><strong>debian/control</strong></span> 按照“Debian政策手冊”中 <a class="ulink" href="https://www.debian.org/doc/debian-policy/#source-package-control-files-debian-control">5.2 原始碼包控制檔案——debian/control</a> 的內容使用 RFC-822 風格進行編寫。檔案對空行和行首空格的使用有特別的要求。</p>
              </td>
            </tr>
          </table>
        </div>
        <p>這裡的 <span class="strong"><strong>debian/copyright</strong></span> 提供了 Debian 套件版權資料的總結。此時該檔案是由 <span class="strong"><strong>debmake</strong></span> 命令產生的模板檔案。</p>
        <p><strong><span class="strong"><strong>debian/copyright</strong></span>（模板檔案）：. </strong>
</p>
        <pre class="screen"> $ cat debhello-0.0/debian/copyright
Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
Upstream-Name: debhello
Source: &lt;url://example.com&gt;
#
# Please double check copyright with the licensecheck(1) command.

Files:     Makefile
           src/hello.c
Copyright: __NO_COPYRIGHT_NOR_LICENSE__
License:   __NO_COPYRIGHT_NOR_LICENSE__

#----------------------------------------------------------------------------...
# Files marked as NO_LICENSE_TEXT_FOUND may be covered by the following
# license/copyright files.

#----------------------------------------------------------------------------...
# License file: LICENSE
 License:
 .
 All files in this archive are licensed under the MIT License as below.
 .
 Copyright 2015 Osamu Aoki &lt;osamu@debian.org&gt;
 .
 Permission is hereby granted, free of charge, to any person obtaining a
 copy of this software and associated documentation files (the "Software"),
 to deal in the Software without restriction, including without limitation
 the rights to use, copy, modify, merge, publish, distribute, sublicense,
 and/or sell copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following conditions:
 .
 The above copyright notice and this permission notice shall be included
 in all copies or substantial portions of the Software.
 .
 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</pre>
        <p>
</p>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="step-maintainer"/>4.6. 第三步：編輯模板檔案</h2>
            </div>
          </div>
        </div>
        <p>作為維護者，要製作一個合適的 Debian 套件當然需要對模板內容進行一些手工的調整。</p>
        <p>為了將安裝檔案變成系統檔案的一部分，<span class="strong"><strong>Makefile</strong></span> 檔案中 <span class="strong"><strong>$(prefix)</strong></span> 預設的 <span class="strong"><strong>/usr/local</strong></span> 的值需要被覆蓋為 <span class="strong"><strong>/usr</strong></span>。要做到這點，可以按照下面給出的方法，在 <span class="strong"><strong>debian/rules</strong></span> 檔案中新增名為 <span class="strong"><strong>override_dh_auto_install</strong></span> 的目標，在其中設置“<span class="strong"><strong>prefix=/usr</strong></span>”。</p>
        <p><strong><span class="strong"><strong>debian/rules</strong></span>（維護者版本）：. </strong>
</p>
        <pre class="screen"> $ vim debhello-0.0/debian/rules
 ... hack, hack, hack, ...
 $ cat debhello-0.0/debian/rules
#!/usr/bin/make -f
export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed

%:
        dh $@

override_dh_auto_install:
        dh_auto_install -- prefix=/usr</pre>
        <p>
</p>
        <p>如上在 <span class="strong"><strong>debian/rules</strong></span> 檔案中匯出=<span class="strong"><strong>DH_VERBOSE</strong></span> 環境變數可以強制 <span class="strong"><strong>debhelper</strong></span> 工具輸出細粒度的構建報告。</p>
        <p>如上匯出 <span class="strong"><strong>DEB_BUILD_MAINT_OPTION</strong></span> 變數可以如 <span class="strong"><strong>dpkg-buildflags</strong></span>(1) 手冊頁中“FEATURE AREAS/ENVIRONMENT”部分所說，對強化選項進行設定。<a href="#ftn.idm1129" class="footnote" id="idm1129"><sup class="footnote">[8]</sup></a></p>
        <p>如上匯出 <span class="strong"><strong>DEB_CFLAGS_MAINT_APPEND</strong></span> 可以強制 C 編譯器給出所有型別的警告內容。</p>
        <p>如上匯出 <span class="strong"><strong>DEB_LDFLAGS_MAINT_APPEND</strong></span> 可以強制連結器只對真正需要的程式庫進行連結。<a href="#ftn.idm1136" class="footnote" id="idm1136"><sup class="footnote">[9]</sup></a></p>
        <p>對基於 Makefile 的構建系統來說，<span class="strong"><strong>dh_auto_install</strong></span> 命令所做的基本上就是“<span class="strong"><strong>$(MAKE) install DESTDIR=debian/debhello</strong></span>”。這裡建立的 <span class="strong"><strong>override_dh_auto_install</strong></span> 目標將其行為修改為“<span class="strong"><strong>$(MAKE) install DESTDIR=debian/debhello prefix=/usr</strong></span>”。</p>
        <p>這裡是維護者版本的 <span class="strong"><strong>debian/control</strong></span> 和 <span class="strong"><strong>debian/copyright</strong></span> 檔案。</p>
        <p><strong><span class="strong"><strong>debian/control</strong></span>（維護者版本）：. </strong>
</p>
        <pre class="screen"> $ vim debhello-0.0/debian/control
 ... hack, hack, hack, ...
 $ cat debhello-0.0/debian/control
Source: debhello
Section: devel
Priority: optional
Maintainer: Osamu Aoki &lt;osamu@debian.org&gt;
Build-Depends: debhelper (&gt;=11~)
Standards-Version: 4.3.0
Homepage: https://salsa.debian.org/debian/debmake-doc

Package: debhello
Architecture: any
Multi-Arch: foreign
Depends: ${misc:Depends}, ${shlibs:Depends}
Description: example package in the debmake-doc package
 This is an example package to demonstrate Debian packaging using
 the debmake command.
 .
 The generated Debian package uses the dh command offered by the
 debhelper package and the dpkg source format `3.0 (quilt)'.</pre>
        <p>
</p>
        <p><strong><span class="strong"><strong>debian/copyright</strong></span>（維護者版本）：. </strong>
</p>
        <pre class="screen"> $ vim debhello-0.0/debian/copyright
 ... hack, hack, hack, ...
 $ cat debhello-0.0/debian/copyright
Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
Upstream-Name: debhello
Source: https://salsa.debian.org/debian/debmake-doc

Files:     *
Copyright: 2015 Osamu Aoki &lt;osamu@debian.org&gt;
License:   Expat
 Permission is hereby granted, free of charge, to any person obtaining a
 copy of this software and associated documentation files (the "Software"),
 to deal in the Software without restriction, including without limitation
 the rights to use, copy, modify, merge, publish, distribute, sublicense,
 and/or sell copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following conditions:
 .
 The above copyright notice and this permission notice shall be included
 in all copies or substantial portions of the Software.
 .
 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</pre>
        <p>
</p>
        <p>在 <span class="strong"><strong>debian/</strong></span> 目錄下還有一些其它的模板文件。它們也需要進行更新。</p>
        <p><strong><span class="strong"><strong>debian/</strong></span>. 下面的模板檔案（0.0 版）：. </strong>
</p>
        <pre class="screen"> $ tree debhello-0.0/debian
debhello-0.0/debian
├── README.Debian
├── changelog
├── compat
├── control
├── copyright
├── patches
│   └── series
├── rules
├── source
│   ├── format
│   └── local-options
└── watch

2 directories, 10 files</pre>
        <p>
</p>
        <div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Tip">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[提示]" src="images/tip.png"/>
              </td>
              <th align="left">提示</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>對於來自 <span class="strong"><strong>debhelper</strong></span> 套件的各個 <span class="strong"><strong>dh_</strong></span>* 命令來說，它們在讀取所使用的配置文件時通常把以 # 開頭的行視為註釋行。</p>
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="step-debuild"/>4.7. 第四步：使用 debuild 構建套件</h2>
            </div>
          </div>
        </div>
        <p>您可以使用 <span class="strong"><strong>debuild</strong></span> 或者等效的命令工具（參見 <a class="xref" href="ch04.zh-tw.html#what-debuild" title="4.3. 什麼是 debuild？">節 4.3, “什麼是 debuild？”</a>）在這個原始碼樹內構建一個非原生 Debian 套件。命令的輸出通常十分詳細，如下所示，它會對構建中執行的操作進行解釋。</p>
        <pre class="screen"> $ cd debhello-0.0
 $ debuild
 dpkg-buildpackage -us -uc -ui -i
 ...
 fakeroot debian/rules clean
dh clean
 ...
 debian/rules build
dh build
   dh_update_autotools_config
   dh_autoreconf
   dh_auto_configure
   dh_auto_build
        make -j4 "INSTALL=install --strip-program=true"
make[1]: Entering directory '/path/to/debhello-0.0'
# CFLAGS=-g -O2
# -fdebug-prefix-map=/home/ycheng/debian/debmake-doc/debhello-0.0-pkg1/t
# est/debhello-0.0=. -fstack-protector-strong -Wformat
 ...
 fakeroot debian/rules binary
dh binary
 ...
Now running lintian debhello_0.0-1_amd64.changes ...
 ...
W: debhello: binary-without-manpage usr/bin/hello
Finished running lintian.

 ...</pre>
        <p>這裡驗證了 <span class="strong"><strong>CFLAGS</strong></span> 已經得到了更新，新增了 <span class="strong"><strong>-Wall</strong></span> 和 <span class="strong"><strong>-pendatic</strong></span> 引數；這是我們先前在 <span class="strong"><strong>DEB_CFLAGS_MAINT_APPEND</strong></span> 變數中所指定的。</p>
        <p>根據 <span class="strong"><strong>lintian</strong></span> 的報告，您應該如同後文中的例子那樣（請見 <a class="xref" href="ch08.zh-tw.html" title="章 8. 更多範例">章 8, <em>更多範例</em></a>）為套件新增 man 手冊頁。我們這裡暫且跳過這部分內容。</p>
        <p>現在我們來看看成果如何。</p>
        <p><strong><span class="strong"><strong>debhello</strong></span> <span class="strong"><strong>0.0</strong></span> 版使用 <span class="strong"><strong>debuild</strong></span> 命令產生的文件：. </strong>
</p>
        <pre class="screen"> $ cd ..
 $ tree -FL 1
.
├── debhello-0.0/
├── debhello-0.0.tar.gz
├── debhello-dbgsym_0.0-1_amd64.ddeb
├── debhello_0.0-1.debian.tar.xz
├── debhello_0.0-1.dsc
├── debhello_0.0-1_amd64.build
├── debhello_0.0-1_amd64.buildinfo
├── debhello_0.0-1_amd64.changes
├── debhello_0.0-1_amd64.deb
└── debhello_0.0.orig.tar.gz -&gt; debhello-0.0.tar.gz

1 directory, 9 files</pre>
        <p>
</p>
        <p>您可以看見生成的全部檔案。</p>
        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem"><span class="strong"><strong>debhello_0.0.orig.tar.gz</strong></span> 是指向上游原始碼壓縮包的符號連結。</li>
            <li class="listitem"><span class="strong"><strong>debhello_0.0-1.debian.tar.xz</strong></span> 包含了維護者生成的內容。</li>
            <li class="listitem"><span class="strong"><strong>debhello_0.0-1.dsc</strong></span> 是 Debian 原始碼包的元資料檔案。</li>
            <li class="listitem"><span class="strong"><strong>debhello_0.0-1_amd64.deb</strong></span> 是 Debian 二進制套件。</li>
            <li class="listitem"><span class="strong"><strong>debhello-dbgsym_0.0-1_amd64.deb</strong></span> 是 Debian 的除錯符號二進位制套件。另請參見 <a class="xref" href="ch05.zh-tw.html#dbgsym" title="5.17.1. 新的 -dbgsym 套件（Stretch 9.0 或更新）">節 5.17.1, “新的 -dbgsym 套件（Stretch 9.0 或更新）”</a>。</li>
            <li class="listitem"><span class="strong"><strong>debhello_0.0-1_amd64.build</strong></span> 是構建日誌文件。</li>
            <li class="listitem"><span class="strong"><strong>debhello_0.0-1_amd64.buildinfo</strong></span> 是 <span class="strong"><strong>dpkg-genbuildinfo</strong></span>(1) 生成的元資料檔案。</li>
            <li class="listitem"><span class="strong"><strong>debhello_0.0-1_amd64.changes</strong></span> 是 Debian 二進位制套件的元資料檔案。</li>
          </ul>
        </div>
        <p><span class="strong"><strong>debhello_0.0-1.debian.tar.xz</strong></span> 包含了 Debian 對上游原始碼的修改，具體如下所示。</p>
        <p><strong>壓縮檔案 <span class="strong"><strong>debhello_0.0-1.debian.tar.xz</strong></span> 的內容：. </strong>
</p>
        <pre class="screen"> $ tar -tzf debhello-0.0.tar.gz
debhello-0.0/
debhello-0.0/LICENSE
debhello-0.0/src/
debhello-0.0/src/hello.c
debhello-0.0/Makefile
 $ tar --xz -tf debhello_0.0-1.debian.tar.xz
debian/
debian/README.Debian
debian/changelog
debian/compat
debian/control
debian/copyright
debian/patches/
debian/patches/series
debian/rules
debian/source/
debian/source/format
debian/watch</pre>
        <p>
</p>
        <p><span class="strong"><strong>debhello_0.0-1_amd64.deb</strong></span> 包含了將要安裝至目標系統中的檔案。</p>
        <p><span class="strong"><strong>debhello-debsym_0.0-1_amd64.deb</strong></span> 包含了將要安裝至目標系統中的除錯符號檔案。</p>
        <p><strong>所有二進位制包的包內容：. </strong>
</p>
        <pre class="screen"> $ dpkg -c debhello_0.0-1_amd64.deb
drwxr-xr-x root/root ...  ./
drwxr-xr-x root/root ...  ./usr/
drwxr-xr-x root/root ...  ./usr/bin/
-rwxr-xr-x root/root ...  ./usr/bin/hello
drwxr-xr-x root/root ...  ./usr/share/
drwxr-xr-x root/root ...  ./usr/share/doc/
drwxr-xr-x root/root ...  ./usr/share/doc/debhello/
-rw-r--r-- root/root ...  ./usr/share/doc/debhello/README.Debian
-rw-r--r-- root/root ...  ./usr/share/doc/debhello/changelog.Debian.gz
-rw-r--r-- root/root ...  ./usr/share/doc/debhello/copyright</pre>
        <p>
</p>
        <p>生成的依賴列表會給出所有二進位制套件的依賴。</p>
        <p><strong>生成的所有二進位制套件的依賴列表（v=0.0）：. </strong>
</p>
        <pre class="screen"> $ dpkg -f debhello_0.0-1_amd64.deb pre-depends \
            depends recommends conflicts breaks
Depends: libc6 (&gt;= 2.2.5)</pre>
        <p>
</p>
        <div class="caution" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Caution">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[注意]" src="images/caution.png"/>
              </td>
              <th align="left">注意</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>在將套件上傳至 Debian 倉庫之前，仍然有很多細節需要進行處理。</p>
              </td>
            </tr>
          </table>
        </div>
        <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Note">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[注意]" src="images/note.png"/>
              </td>
              <th align="left">注意</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>如果跳過了對 <span class="strong"><strong>debmake</strong></span> 命令自動生成的配置檔案的手工調整步驟，所生成的二進位制套件可能缺少有用的套件描述資訊，某些政策的要求也無法滿足。這個不正式的套件對於 <span class="strong"><strong>dpkg</strong></span> 命令來說可以正常處理，也許這樣對您本地的部署來說已經足夠好了。</p>
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div class="section">
        <div class="titlepage">
          <div>
            <div>
              <h2 class="title"><a id="alt-patch"/>4.8. 第三步（備選）：修改上游原始碼</h2>
            </div>
          </div>
        </div>
        <p>上面的例子中，在建立合適的 Debian 套件時沒有修改上游的原始碼。</p>
        <p>作為維護者，另一個備選的方案是對上游原始碼做改動，如修改上游的 <span class="strong"><strong>Makefile</strong></span> 以將 $(prefix) 的值設定為 <span class="strong"><strong>/usr</strong></span>。</p>
        <p>打包操作基本上和上面的分步範例相同，除了在 <a class="xref" href="ch04.zh-tw.html#step-maintainer" title="4.6. 第三步：編輯模板檔案">節 4.6, “第三步：編輯模板檔案”</a> 中的兩點：</p>
        <div class="itemizedlist">
          <ul class="itemizedlist">
            <li class="listitem">
              <p class="simpara">要將維護者對上游原始碼的修改形成對應的補丁檔案存放在 <span class="strong"><strong>debian/patches/</strong></span> 目錄內，並將它們的檔名寫入 <span class="strong"><strong>debian/patches/series</strong></span> 檔案，如 <a class="xref" href="ch05.zh-tw.html#patches" title="5.8. debian/patches/*">節 5.8, “debian/patches/*”</a> 所述。有數種生成補丁檔案的方式。下面的章節中給出了一些例子：</p>
              <div class="itemizedlist">
                <ul class="itemizedlist">
                  <li class="listitem">
<a class="xref" href="ch04.zh-tw.html#diff-u" title="4.8.1. 使用 diff -u 處理補丁">節 4.8.1, “使用 diff -u 處理補丁”</a>
</li>
                  <li class="listitem">
<a class="xref" href="ch04.zh-tw.html#dquilt" title="4.8.2. 使用 dquilt 處理補丁">節 4.8.2, “使用 dquilt 處理補丁”</a>
</li>
                  <li class="listitem">
<a class="xref" href="ch04.zh-tw.html#dpkg-source-commit" title="4.8.3. 使用 dpkg-source --commit 處理補丁">節 4.8.3, “使用 dpkg-source --commit 處理補丁”</a>
</li>
                </ul>
              </div>
            </li>
            <li class="listitem">
              <p class="simpara">此時維護者對 <span class="strong"><strong>debian/rules</strong></span> 檔案的修改如下所示，它不包含 <span class="strong"><strong>override_dh_auto_install</strong></span> 目標：</p>
              <p><strong><span class="strong"><strong>debian/rules</strong></span>（備選的維護者版本）：. </strong>
</p>
              <pre class="screen"> $ cd debhello-0.0
 $ vim debian/rules
 ... hack, hack, hack, ...
 $ cat debian/rules
#!/usr/bin/make -f
export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed

%:
        dh $@</pre>
              <p>
</p>
            </li>
          </ul>
        </div>
        <p>這個使用一系列補丁檔案進行 Debian 打包的備選方案對於應對上游未來的改變可能不夠健壯，但是在應對更為複雜的上游原始碼時可以更靈活。（參見 <a class="xref" href="ch07.zh-tw.html#deb3" title="7.13. 3.0 原始碼格式">節 7.13, “3.0 原始碼格式”</a>。）</p>
        <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Note">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[注意]" src="images/note.png"/>
              </td>
              <th align="left">注意</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>對當前這個特定的打包場景，前文的 <a class="xref" href="ch04.zh-tw.html#step-maintainer" title="4.6. 第三步：編輯模板檔案">節 4.6, “第三步：編輯模板檔案”</a> 中使用 <span class="strong"><strong>debian/rules</strong></span> 檔案的方式更好一些。但為了演示起見，此時我們先使用本節的方式繼續操作。</p>
              </td>
            </tr>
          </table>
        </div>
        <div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;">
          <table border="0" summary="Tip">
            <tr>
              <td rowspan="2" align="center" valign="top">
                <img alt="[提示]" src="images/tip.png"/>
              </td>
              <th align="left">提示</th>
            </tr>
            <tr>
              <td align="left" valign="top">
                <p>對更復雜的打包場景，可能需要同時應用 <a class="xref" href="ch04.zh-tw.html#step-maintainer" title="4.6. 第三步：編輯模板檔案">節 4.6, “第三步：編輯模板檔案”</a> 和 <a class="xref" href="ch04.zh-tw.html#alt-patch" title="4.8. 第三步（備選）：修改上游原始碼">節 4.8, “第三步（備選）：修改上游原始碼”</a> 中的方式。</p>
              </td>
            </tr>
          </table>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="diff-u"/>4.8.1. 使用 diff -u 處理補丁</h3>
              </div>
            </div>
          </div>
          <p>這裡我們使用 <span class="strong"><strong>diff</strong></span> 命令建立一個 <span class="strong"><strong>000-prefix-usr.patch</strong></span> 檔案作為例子。</p>
          <pre class="screen"> $ cp -a debhello-0.0 debhello-0.0.orig
 $ vim debhello-0.0/Makefile
 ... hack, hack, hack, ...
 $ diff -Nru debhello-0.0.orig debhello-0.0 &gt;000-prefix-usr.patch
 $ cat 000-prefix-usr.patch
diff -Nru debhello-0.0.orig/Makefile debhello-0.0/Makefile
--- debhello-0.0.orig/Makefile  2019-11-19 07:27:23.659464636 +0800
+++ debhello-0.0/Makefile       2019-11-19 07:27:23.771491701 +0800
@@ -1,4 +1,4 @@
-prefix = /usr/local
+prefix = /usr

 all: src/hello

 $ rm -rf debhello-0.0
 $ mv -f debhello-0.0.orig debhello-0.0</pre>
          <p>請注意，上游的原始碼樹應當恢復到原始狀態，補丁檔案此時的名字為 <span class="strong"><strong>000-prefix-usr.patch</strong></span>。</p>
          <p>這個 <span class="strong"><strong>000-prefix-usr.patch</strong></span> 檔案隨後應當進行編輯以使其符合 <a class="ulink" href="http://dep.debian.net/deps/dep3/">DEP-3</a>，並照如下方式移動至正確的位置。</p>
          <pre class="screen"> $ cd debhello-0.0
 $ echo '000-prefix-usr.patch' &gt;debian/patches/series
 $ vim ../000-prefix-usr.patch
 ... hack, hack, hack, ...
 $ mv -f ../000-prefix-usr.patch debian/patches/000-prefix-usr.patch
 $ cat debian/patches/000-prefix-usr.patch
From: Osamu Aoki &lt;osamu@debian.org&gt;
Description: set prefix=/usr patch
diff -Nru debhello-0.0.orig/Makefile debhello-0.0/Makefile
--- debhello-0.0.orig/Makefile
+++ debhello-0.0/Makefile
@@ -1,4 +1,4 @@
-prefix = /usr/local
+prefix = /usr

 all: src/hello</pre>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="dquilt"/>4.8.2. 使用 dquilt 處理補丁</h3>
              </div>
            </div>
          </div>
          <p>這裡的例子使用 <span class="strong"><strong>dquilt</strong></span> 命令（一個 <span class="strong"><strong>quilt</strong></span> 程式的簡單封裝）建立 <span class="strong"><strong>000-prefix-usr.patch</strong></span>。<span class="strong"><strong>dquilt</strong></span> 命令的語法和功能與 <span class="strong"><strong>quilt</strong></span>(1) 命令相同，唯一的區別在於補丁儲存在 <span class="strong"><strong>debian/patches/</strong></span> 目錄中。</p>
          <pre class="screen"> $ cd debhello-0.0
 $ dquilt new 000-prefix-usr.patch
Patch debian/patches/000-prefix-usr.patch is now on top
 $ dquilt add Makefile
File Makefile added to patch debian/patches/000-prefix-usr.patch
 ... hack, hack, hack, ...
 $ head -1 Makefile
prefix = /usr
 $ dquilt refresh
Refreshed patch debian/patches/000-prefix-usr.patch
 $ dquilt header -e --dep3
 ... edit the DEP-3 patch header with editor
 $ tree -a
.
├── .pc
│   ├── .quilt_patches
│   ├── .quilt_series
│   ├── .version
│   ├── 000-prefix-usr.patch
│   │   ├── .timestamp
│   │   └── Makefile
│   └── applied-patches
├── LICENSE
├── Makefile
├── debian
│   ├── README.Debian
│   ├── changelog
│   ├── compat
│   ├── control
│   ├── copyright
│   ├── patches
│   │   ├── 000-prefix-usr.patch
│   │   └── series
│   ├── rules
│   ├── source
│   │   ├── format
│   │   └── local-options
│   └── watch
└── src
    └── hello.c

6 directories, 20 files
 $ cat debian/patches/series
000-prefix-usr.patch
 $ cat debian/patches/000-prefix-usr.patch
Description: set prefix=/usr patch
Author: Osamu Aoki &lt;osamu@debian.org&gt;
Index: debhello-0.0/Makefile
===================================================================
--- debhello-0.0.orig/Makefile
+++ debhello-0.0/Makefile
@@ -1,4 +1,4 @@
-prefix = /usr/local
+prefix = /usr

 all: src/hello</pre>
          <p>這裡，上游原始碼樹中的 <span class="strong"><strong>Makefile</strong></span> 檔案沒有恢復到原始狀態的必要。在 <a class="xref" href="ch04.zh-tw.html#step-debuild" title="4.7. 第四步：使用 debuild 構建套件">節 4.7, “第四步：使用 debuild 構建套件”</a> 描述的 Debian 打包過程中呼叫的 <span class="strong"><strong>dpkg-source</strong></span> 命令能夠理解由 <span class="strong"><strong>dquilt</strong></span> 程式在 <span class="strong"><strong>.pc/</strong></span> 目錄中記錄的補丁應用情況。只要所有這些修改都是由 <span class="strong"><strong>dquilt</strong></span> 命令完成的，那麼 Debian 原始碼包就可以從經過修改的原始碼樹中進行構建。</p>
          <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;">
            <table border="0" summary="Note">
              <tr>
                <td rowspan="2" align="center" valign="top">
                  <img alt="[注意]" src="images/note.png"/>
                </td>
                <th align="left">注意</th>
              </tr>
              <tr>
                <td align="left" valign="top">
                  <p>如果 <span class="strong"><strong>.pc/</strong></span> 目錄不存在，<span class="strong"><strong>dpkg-source</strong></span> 命令就會假定沒有應用任何補丁。這就是更為原始的補丁生成方法，例如 <a class="xref" href="ch04.zh-tw.html#diff-u" title="4.8.1. 使用 diff -u 處理補丁">節 4.8.1, “使用 diff -u 處理補丁”</a> 中未生成 <span class="strong"><strong>.pc/</strong></span> 目錄的情況下要求將上游原始碼樹進行恢復的原因。</p>
                </td>
              </tr>
            </table>
          </div>
        </div>
        <div class="section">
          <div class="titlepage">
            <div>
              <div>
                <h3 class="title"><a id="dpkg-source-commit"/>4.8.3. 使用 dpkg-source --commit 處理補丁</h3>
              </div>
            </div>
          </div>
          <p>這裡給出使用“<span class="strong"><strong>dpkg-source --commit</strong></span>”命令生成 <span class="strong"><strong>000-prefix-usr.patch</strong></span> 的例子。</p>
          <p>我們先來編輯上游原始碼。</p>
          <pre class="screen"> $ cd debhello-0.0
 $ vim Makefile
 ... hack, hack, hack, ...
 $ head -n1 Makefile
prefix = /usr</pre>
          <p>我們來進行提交。</p>
          <pre class="screen"> $ dpkg-source --commit . 000-prefix-usr.patch
... editor to edit the DEP-3 patch header
...</pre>
          <p>我們來看看效果如何。</p>
          <pre class="screen"> $ cat debian/patches/series
000-prefix-usr.patch
 $ cat debian/patches/000-prefix-usr.patch
Description: set prefix=/usr patch
Author: Osamu Aoki &lt;osamu@debian.org&gt;
Index: debhello-0.0/Makefile

--- debhello-0.0.orig/Makefile
+++ debhello-0.0/Makefile
@@ -1,4 +1,4 @@
-prefix = /usr/local
+prefix = /usr

 all: src/hello

 $ tree -a
.
├── .pc
│   ├── .quilt_patches
│   ├── .quilt_series
│   ├── .version
│   ├── 000-prefix-usr.patch
│   │   ├── .timestamp
│   │   └── Makefile
│   └── applied-patches
├── LICENSE
├── Makefile
├── debian
│   ├── README.Debian
│   ├── changelog
│   ├── compat
│   ├── control
│   ├── copyright
│   ├── patches
│   │   ├── 000-prefix-usr.patch
│   │   └── series
│   ├── rules
│   ├── source
│   │   ├── format
│   │   └── local-options
│   └── watch
└── src
    └── hello.c

6 directories, 20 files</pre>
          <p>這裡，<span class="strong"><strong>dpkg-source</strong></span> 命令完成了與 <a class="xref" href="ch04.zh-tw.html#dquilt" title="4.8.2. 使用 dquilt 處理補丁">節 4.8.2, “使用 dquilt 處理補丁”</a> 一節中使用 <span class="strong"><strong>dquilt</strong></span> 命令完全相同的流程。</p>
        </div>
      </div>
      <div class="footnotes">
        <br/>
        <hr/>
        <div id="ftn.idm1129" class="footnote">
          <p><a href="#idm1129" class="simpara"><sup class="simpara">[8] </sup></a>這裡的做法是為了進行強化而強制啟用只讀重定位連結，以此避免 lintian 的警告“<span class="strong"><strong>W: debhello: hardening-no-relro usr/bin/hello</strong></span>”。其實它在本例中並不是必要的，但加上也沒有什麼壞處。對於沒有外部鏈接程式庫的本例來說，lintian 似乎給出了誤報的警告。</p>
        </div>
        <div id="ftn.idm1136" class="footnote">
          <p><a href="#idm1136" class="simpara"><sup class="simpara">[9] </sup></a>這裡的做法是為了避免在依賴程式庫情況複雜的情況下過度連結，例如某些 GNOME 程式。這樣做對這裡的簡單例子來說並不是必要的，但應當是無害的。</p>
        </div>
      </div>
    </div>
    <div class="navfooter">
      <hr/>
      <table width="100%" summary="Navigation footer">
        <tr>
          <td align="left"><a accesskey="p" href="ch03.zh-tw.html"><img src="images/prev.png" alt="前一頁"/></a> </td>
          <td align="center"> </td>
          <td align="right"> <a accesskey="n" href="ch05.zh-tw.html"><img src="images/next.png" alt="下一頁"/></a></td>
        </tr>
        <tr>
          <td align="left" valign="top">章 3. 工具的配置 </td>
          <td align="center">
            <a accesskey="h" href="index.zh-tw.html">
              <img src="images/home.png" alt="起始頁"/>
            </a>
          </td>
          <td align="right" valign="top"> 章 5. 基本內容</td>
        </tr>
      </table>
    </div>
  </body>
</html>
